<template>
  <div class="space-y-6">
    <h3 class="text-2xl font-semibold text-gray-900">
      {{ formattedSelectedDate }} ÁöÑË°åÁ®ã
    </h3>

    <div class="departure-time">
      <label>Âá∫ÁôºÊôÇÈñìÔºö</label>
      <input
        type="time"
        v-model="departureTime"
        @change="updateDepartureTime"
      />
    </div>

    <div v-if="itineraryForSelectedDay.length" class="itinerary-list">
      <draggable
        v-model="itineraryForSelectedDay"
        :group="{ name: 'places', pull: 'clone', put: true }"
        :animation="250"
        item-key="index"
        @end="handleDragEnd"
      >
        <template #item="{ element, index }" :key="index">
          <ul class="itinerary-item-list">
            <li class="itinerary-item">
              <!-- Âà™Èô§ÊåâÈàï -->
              <button @click="deletePlace(index)" class="delete-button">
                ‚úñ
              </button>

              <div class="itinerary-details">
                <div class="stay-time-header">
                  <!-- ÈÄôË£°ÂëºÂè´ StayTime ÁµÑ‰ª∂ -->
                  <StayTime
                    :date="formattedSelectedDate"
                    :departureTime="departureTime"
                    :itinerary="itineraryForSelectedDay"
                    :index="index"
                  />

                  <!-- È°ØÁ§∫Ë∂ÖÈÄ£ÁµêÊ®°Âºè -->
                  <a
                    v-if="!isEditing(index)"
                    href="#"
                    @click.prevent="editStayTime(index)"
                    class="stay-duration-link"
                  >
                    {{
                      itineraryStore.getStayDuration(
                        formattedSelectedDate,
                        index
                      )
                    }}
                    ÂàÜÈêò
                  </a>

                  <!-- Á∑®ËºØÊ®°Âºè -->
                  <input
                    v-else
                    type="number"
                    :value="tempValue(index)"
                    class="stay-duration-input"
                    @blur="saveStayTime(index, $event.target.value)"
                    @keyup.enter="saveStayTime(index, $event.target.value)"
                  />
                </div>

                <div class="itinerary-info">
                  <img
                    :src="getPhotoUrl(element.photos[0])"
                    v-if="element.photos && element.photos.length"
                    alt="Location Image"
                    class="location-image"
                  />
                  <div>
                    <h4 class="location-title">{{ element.placeName }}</h4>
                    <p class="location-address">{{ element.placeAddress }}</p>
                  </div>
                </div>
              </div>
            </li>

            <!-- Âú®Ë°åÁ®ã‰πãÈñìÊèíÂÖ• RouteTime -->
            <div
              v-if="index < itineraryForSelectedDay.length - 1"
              class="route-time"
            >
              <RouteTime :date="formattedSelectedDate" :index="index" />
            </div>
          </ul>
        </template>
      </draggable>
    </div>

    <div v-else>
      <p>‰ªäÂ§©ÈÇÑÊ≤íÊúâÊñ∞Â¢ûË°åÁ®ãÔºÅ</p>
    </div>
  </div>
</template>

<script setup>
import { onBeforeRouteLeave, useRouter } from "vue-router";
import { onMounted, onUnmounted, ref, computed, watch } from "vue";
import { useItineraryStore } from "@/stores/ItineraryStore";
import { useScheduleStore } from "@/stores/ScheduleStore";
import { useEventStore } from "@/stores/EventStore";
import { usePlaceStore } from "@/stores/PlaceStore";
import { useEventPlaceStore } from "@/stores/EventPlaceStore";

import RouteTime from "./RouteTime.vue";
import draggable from "vuedraggable";
import StayTime from "./StayTime.vue";

const props = defineProps({
  selectedDate: String,
});

// ------------- Pinia & Store -------------
const itineraryStore = useItineraryStore();
const scheduleStore = useScheduleStore();
const eventStore = useEventStore();
const placeStore = usePlaceStore();
const eventPlaceStore = useEventPlaceStore();

// ------------- UI ÁãÄÊÖã -------------
const hasUnsavedChanges = ref(false);
const eventData = ref({});

// ------------- Êó•ÊúüËΩâÊèõ -------------
const formattedSelectedDate = computed(() => {
  if (!props.selectedDate) return "";
  const cleanedDate = props.selectedDate.replace(/[^0-9\/]/g, "");
  if (cleanedDate.includes("-")) return cleanedDate;

  const baseYear =
    scheduleStore.currentSchedule?.startDate?.split("-")[0] ||
    new Date().getFullYear();
  const [month, day] = cleanedDate
    .split("/")
    .map((num) => num.padStart(2, "0"));
  return `${baseYear}-${month}-${day}`;
});

watch(
  () => props.selectedDate,
  (newDate) => {
    // console.log("üìÖ `PlanningDay.vue` Êî∂Âà∞ÁöÑ `selectedDate`: ", newDate);
  },
  { immediate: true }
);

// ------------- Âá∫ÁôºÊôÇÈñì -------------
const updateDepartureTime = (event) => {
  const newTime = event.target.value;
  itineraryStore.setStartTime(formattedSelectedDate.value, newTime);
  hasUnsavedChanges.value = true;
};

const departureTime = computed({
  get: () => itineraryStore.getStartTime(formattedSelectedDate.value),
  set: (newTime) => {
    itineraryStore.setStartTime(formattedSelectedDate.value, newTime);
    hasUnsavedChanges.value = true;
  },
});

// ------------- ÂæûÂæåÁ´ØËÆÄÂèñË≥áÊñô -------------
watch(
  () => formattedSelectedDate.value,
  async (newDate) => {
    if (!newDate) return;
    console.log(`üìÖ ÈÅ∏ÊìáÁöÑÊó•Êúü: ${newDate}`);

    // ÂæûÂæåÁ´ØÁç≤ÂèñË°åÁ®ãË≥áÊñô
    const event =
      (await eventStore.fetchEventByDate(
        scheduleStore.currentSchedule.tripId,
        newDate
      )) || {};
    console.log("üîç ÂæûÂæåÁ´ØÁç≤ÂèñÁöÑ `event`: ", event);

    eventData.value = { eventId: event.eventId ?? null };

    let placesWithDetails = [];
    if (event.eventXPlaceBeans) {
      console.log(
        "üìç ÂæûÂæåÁ´ØÁç≤ÂèñÁöÑ `eventXPlaceBeans`:",
        event.eventXPlaceBeans
      );

      const placeIds = event.eventXPlaceBeans.map((e) => e.placeId);
      // console.log("üìç ÈúÄË¶ÅÂä†ËºâÁöÑÂú∞Èªû ID:", placeIds);

      await placeStore.fetchMultiplePlaces(placeIds);
      console.log(
        "‚úÖ `placeStore.placeDetailsMap`:",
        placeStore.placeDetailsMap
      );

      // Â∞áÂú∞ÈªûË©≥Á¥∞Ë≥áË®äÂêà‰Ωµ
      placesWithDetails = event.eventXPlaceBeans.map((eventPlace) => {
        const placeDetails = placeStore.getPlaceDetailById(eventPlace.placeId);
        return {
          ...eventPlace,
          placeName: placeDetails?.placeName ?? "Êú™Áü•Âú∞Èªû",
          placeAddress: placeDetails?.placeAddress ?? "Êú™Áü•Âú∞ÂùÄ",
          photos: placeDetails?.photos ?? [],
          latitude: placeDetails?.latitude ?? null,
          longitude: placeDetails?.longitude ?? null,
          stayDuration: eventPlace.stayDuration ?? "00:00:00",
        };
      });
    }

    console.log("‚úÖ ËôïÁêÜÂæåÁöÑ `placesWithDetails`:", placesWithDetails);

    // Â≠òÂÖ• Pinia
    itineraryStore.setItinerary(newDate, placesWithDetails);
    itineraryStore.setStartTime(newDate, event.startTime ?? "08:00");
    console.log(
      "‚úÖ Â∑≤Â≠òÂÖ• PiniaÔºö",
      itineraryStore.getItineraryForDay(newDate)
    );
  },
  { immediate: true }
);

// ------------- Ë°åÁ®ãË≥áÊñô (computed) -------------
const itineraryForSelectedDay = computed({
  get: () => {
    const date = formattedSelectedDate.value;
    if (!date) return [];
    return itineraryStore.getItineraryForDay(date) || [];
  },
  set: (newItinerary) => {
    const date = formattedSelectedDate.value;
    if (!date) return;
    itineraryStore.setItinerary(date, newItinerary);
  },
});

// ------------- ÊãñÊõ≥ÊéíÂ∫è -------------
const handleDragEnd = () => {
  const date = formattedSelectedDate.value;
  if (!date) return;

  // console.log("üîÑ ÊãñÊõ≥ÁµêÊùüÔºåÊõ¥Êñ∞Ë°åÁ®ãÈ†ÜÂ∫è");
  itineraryStore.setItinerary(date, [...itineraryForSelectedDay.value]);
  hasUnsavedChanges.value = true;
};

// ------------- Âà™Èô§Âú∞Èªû -------------
const deletePlace = (index) => {
  itineraryStore.removePlace(formattedSelectedDate.value, index);
  hasUnsavedChanges.value = true;
};

// ------------- Á∑®ËºØÊ®°ÂºèÁõ∏Èóú -------------
function isEditing(index) {
  // Âæû Pinia ËÆÄÂèñ isEditingStays
  return itineraryStore.getIsEditingStay(formattedSelectedDate.value, index);
}

function tempValue(index) {
  // ËÆÄÂèñÊö´Â≠òÁöÑÂÅúÁïôÊôÇÈñì
  return itineraryStore.getTempStayDuration(formattedSelectedDate.value, index);
}

const editStayTime = (index) => {
  // console.log("üìå Ê≠£Âú®Á∑®ËºØÂÅúÁïôÊôÇÈñì:", index);
  const date = formattedSelectedDate.value;
  if (!date) return;

  // 1. Ë®≠ÂÆö„ÄåÊ≠£Âú®Á∑®ËºØ„Äç
  itineraryStore.setIsEditingStay(date, index, true);

  // 2. ÂàùÂßãÂåñÊö´Â≠òÂÄº (Á≠âÊñºÁèæÊúâÁöÑÊ≠£ÂºèÂÅúÁïôÊôÇÈñì)
  const currentDuration = itineraryStore.getStayDuration(date, index) || 0;
  itineraryStore.setTempStayDuration(date, index, currentDuration);
};

const saveStayTime = (index, duration) => {
  const date = formattedSelectedDate.value;
  if (!date) return;

  // ËΩâÊàêÊï∏Â≠ó
  const validDuration =
    isNaN(duration) || duration === "" ? 0 : Number(duration);

  // 1. ÂØ´Âõû„ÄåÊ≠£Âºè„ÄçÁöÑÂÅúÁïôÊôÇÈñì
  itineraryStore.setStayDuration(date, index, validDuration);

  // 2. ÈóúÈñâÁ∑®ËºØ
  itineraryStore.setIsEditingStay(date, index, false);
  // console.log(
  //   `Saved duration for index ${index}:`,
  //   itineraryStore.getStayDuration(date, index)
  // );

  hasUnsavedChanges.value = true;
};

// ------------- ÂúñÁâáËôïÁêÜ -------------
const getPhotoUrl = (photo) => {
  if (!photo) return "";
  if (typeof photo === "object" && photo.hasOwnProperty("url")) {
    return photo.url;
  }
  return photo;
};

// ------------- Áõ£ËÅΩË°åÁ®ãËÆäÊõ¥ -------------
watch(
  () => formattedSelectedDate.value, // üî• Áõ£ËÅΩÈÅ∏ÊìáÁöÑÊó•ÊúüÔºåËÄå‰∏çÊòØ `itineraryForSelectedDay`
  async (newDate, oldDate) => {
    const eventPlaceStore = useEventPlaceStore();
    if (!oldDate || !eventData.value?.eventId) return; // üî• Á¢∫‰øùÊúâËàäÊó•ÊúüÔºå‰∏î `eventId` Â≠òÂú®

    console.log(`üìÖ Ê∫ñÂÇôÂàáÊèõË°åÁ®ãÔºö${oldDate} ‚ûù ${newDate}`);

    if (hasUnsavedChanges.value) {
      console.log(`üíæ Ê≠£Âú®ÂÑ≤Â≠ò ${oldDate} ÁöÑË°åÁ®ã...`);
      try {
        await eventPlaceStore.saveItineraryToBackend(
          eventData.value.eventId,
          oldDate
        );
        console.log(`‚úÖ ${oldDate} Ë°åÁ®ãÂÑ≤Â≠òÊàêÂäü`);
        hasUnsavedChanges.value = false; // ÊàêÂäüÂÑ≤Â≠òÂæåÈáçÁΩÆ
      } catch (error) {
        console.error(`‚ùå ÁÑ°Ê≥ïÂÑ≤Â≠ò ${oldDate} Ë°åÁ®ã`, error);
      }
    }
  },
  { immediate: false }
);

watch(
  itineraryForSelectedDay,
  () => {
    hasUnsavedChanges.value = true;
    console.log(`üìù Ë°åÁ®ã‰øÆÊîπ: ${formattedSelectedDate.value}`);
  },
  { deep: true }
);

// ------------- Èõ¢ÈñãÊôÇÂÑ≤Â≠ò -------------
onBeforeRouteLeave(async (to, from, next) => {
  const date = formattedSelectedDate.value;

  if (!hasUnsavedChanges.value) {
    next();
    return;
  }
  if (!eventData.value?.eventId) {
    console.warn("‚ö†Ô∏è Ê≤íÊúâ eventIdÔºå‰∏çÈúÄË¶ÅÂêåÊ≠•");
    next();
    return;
  }
  try {
    console.log("üöÄ ÂÑ≤Â≠òË°åÁ®ãËÆäÊõ¥Âà∞ÂæåÁ´Ø...");
    await eventPlaceStore.saveItineraryToBackend(
      eventData.value.eventId,
      formattedSelectedDate.value
    );
    console.log("‚úÖ ÂÑ≤Â≠òÂÆåÊàê");
    hasUnsavedChanges.value = false;
    itineraryStore.clearDayData(date);
    next();
  } catch (error) {
    console.error("‚ùå ÂÑ≤Â≠òÂ§±Êïó", error.message || error);
    if (confirm("ËÆäÊõ¥Êú™ÂÑ≤Â≠òÔºåÊòØÂê¶‰ªçË¶ÅÈõ¢ÈñãÔºü")) {
      itineraryStore.clearDayData(date);
      console.log(`üóëÔ∏è Èõ¢ÈñãÈ†ÅÈù¢ÔºåÊ∏ÖÈô§ ${date} ÁöÑË≥áÊñô`);
      next("/myitineraries"); // üöÄ Ê≠£Á¢∫Â∞éËà™ÊñπÂºè
    } else {
      next(false);
    }
  }
});

// ------------- ÁÄèË¶ΩÂô®ÈóúÈñâÊôÇÊèêÈÜí -------------
const warnUnsavedChanges = (event) => {
  if (hasUnsavedChanges.value) {
    event.preventDefault();
    event.returnValue = "‰Ω†ÊúâÊú™ÂÑ≤Â≠òÁöÑËÆäÊõ¥ÔºåÁ¢∫ÂÆöË¶ÅÈõ¢ÈñãÂóéÔºü";
  }
};

onMounted(() => {
  window.addEventListener("beforeunload", warnUnsavedChanges);
});

onUnmounted(() => {
  window.removeEventListener("beforeunload", warnUnsavedChanges);
});
</script>

<style scoped>
.itinerary-item {
  background: #fff;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
  position: relative;
  transition: all 0.2s ease-in-out;
  list-style: none;
}

.itinerary-details {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.itinerary-info {
  display: flex;
  align-items: center;
  gap: 12px;
}

.location-image {
  width: 64px;
  height: 64px;
  border-radius: 8px;
  object-fit: cover;
}

.stay-time-header {
  display: flex;
  justify-content: space-between;
  align-items: center; /* Á¢∫‰øùÂÖßÂÆπÂûÇÁõ¥ÁΩÆ‰∏≠ */
  font-size: 0.875rem;
  font-weight: 600;
  margin-bottom: 4px;
  padding-right: 30px; /* È†êÁïôÁ©∫ÈñìÔºåÈÅøÂÖçËàáÂà™Èô§ÊåâÈàïÈáçÁñä */
}

.stay-duration-link {
  color: #3b82f6;
  text-decoration: underline;
  cursor: pointer;
}

.stay-duration-input {
  border: 1px solid #ccc;
  padding: 4px 8px;
  width: 50px;
  border-radius: 6px;
  font-size: 0.875rem;
}

.location-title {
  font-size: 1rem;
  font-weight: 600;
  color: #1f2937;
}

.location-address {
  font-size: 0.75rem;
  color: #6b7280;
}

.delete-button {
  position: absolute;
  top: 10px;
  right: 10px;
  background: none;
  color: #d32f2f;
  font-size: 1rem;
  border: none;
  cursor: pointer;
  transition: color 0.2s ease-in-out;
}

.delete-button:hover {
  color: #b91c1c;
}
</style>
