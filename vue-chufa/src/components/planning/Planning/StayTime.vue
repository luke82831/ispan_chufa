<template>
  <div v-if="currentPlaceTime" class="text-gray-500">
    🕒 {{ formatTime(currentPlaceTime.startTime) }} -
    {{ formatTime(currentPlaceTime.endTime) }}
  </div>
</template>

<script setup>
import { computed, watch } from "vue";
import { useItineraryStore } from "@/stores/ItineraryStore";

const props = defineProps({
  date: String, // 日期
  itinerary: Array, // 當天行程列表
  stayDurations: Object, // 停留時間
  index: Number, // 當前地點的索引
});

const itineraryStore = useItineraryStore();

// **取得當天出發時間**
const departureTime = computed(() => itineraryStore.getStartTime(props.date));

// **確保 `stayDurations` 直接使用 props**
const stayDurationsReactive = props.stayDurations;

// **計算每個地點的到達與離開時間**
const computedItinerary = computed(() => {
  if (!departureTime.value || !props.itinerary.length) return [];

  let [year, month, day] = props.date.split("-").map(Number);
  let [hours, minutes] = departureTime.value.split(":").map(Number);
  let baseTime = new Date(year, month - 1, day, hours, minutes);
  let currentTime = new Date(baseTime);

  console.log("🕒 原始 baseTime:", baseTime.toLocaleString());

  let itineraryWithTimes = [];
  const routeTimes = itineraryStore.routeTimes[props.date] || {};
  const stayTimes = itineraryStore.stayDurations[props.date] || {};

  props.itinerary.forEach((place, index) => {
    let travelTime = index > 0 ? routeTimes[index - 1] || 0 : 0; // 取得行車時間
    let stayTime = props.stayDurations?.[place.id] ?? 0; // 停留時間

    let startTime;
    if (index === 0) {
      // ✅ 第 1 個地點，直接使用出發時間
      startTime = new Date(currentTime.getTime());
    } else {
      // ✅ 其他地點：上一個地點的 `endTime` + 行車時間
      startTime = new Date(itineraryWithTimes[index - 1].endTime);
      startTime.setMinutes(startTime.getMinutes() + travelTime);
    }

    let endTime = new Date(startTime.getTime());
    endTime.setMinutes(endTime.getMinutes() + stayTime);

    itineraryWithTimes.push({
      ...place,
      startTime,
      endTime,
    });

    console.log(
      `📌 地點 ${index}: ${startTime.toLocaleString()} - ${endTime.toLocaleString()}`
    );
  });

  return itineraryWithTimes;
});

// **取得對應 `index` 的地點時間**
const currentPlaceTime = computed(() => computedItinerary.value[props.index] || null);

watch(
  () => computedItinerary.value,
  (newVal) => {
    console.log("📌 computedItinerary 變更:", newVal);
  },
  { deep: true }
);

watch(
  () => itineraryStore.routeTimes[props.date],
  (newVal) => {
    console.log("🚗 行車時間變更:", newVal);
  },
  { deep: true }
);

watch(
  () => stayDurationsReactive,
  (newVal) => {
    console.log("⏳ 停留時間變更:", newVal);
  },
  { deep: true }
);

watch(
  () => currentPlaceTime.value,
  (newVal) => {
    console.log("⏰ currentPlaceTime 更新:", JSON.stringify(newVal, null, 2));
  }
);

// **格式化時間 (HH:MM)**
const formatTime = (date) => {
  if (!date) return "時間未設定";
  return new Date(date).toLocaleTimeString("zh-TW", {
    hour: "2-digit",
    minute: "2-digit",
  });
};
</script>
